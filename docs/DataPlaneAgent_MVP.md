# DataPlaneAgent: MVP Requirements Document

**1. Overview & Core Purpose**

This document outlines the minimum viable product (MVP) requirements for the DataPlaneAgent component of the SpeechEngine platform. The DataPlaneAgent serves as a lightweight bridge between AudioAPIServer instances and the centralized ControlPlane, focusing on essential usage tracking, session management, and basic server administration.

**MVP Goals:**
- Direct Redis-based communication between AudioAPIServer and DataPlaneAgent.
- Reliable usage record forwarding to the ControlPlane with retry mechanisms.
- **Proactive session quota management.**
- **Session lifecycle notifications (e.g., completion).**
- Basic health monitoring and server registration.
- Simple, focused architecture suitable for production deployment.

**2. System Integration & Architecture**

The DataPlaneAgent operates as a companion service to each AudioAPIServer instance:

**AudioAPIServer Integration Changes:**
- **MeteringService**: Modified to send usage data and session events directly to Redis queues.
- **QueueManager**: Enhanced to use Redis for inter-service communication.
- **Configuration**: YAML-based configuration with Redis connection settings.

**DataPlaneAgent Core Functions:**
- Process usage records from Redis queues.
- Forward usage records to the ControlPlane with guaranteed delivery.
- **Proactively request additional quota for active sessions.**
- **Notify the ControlPlane when a session is started or completed.**
- Provide basic health monitoring and server registration.
- Execute simple remote management commands.

**3. Core Feature Requirements (MVP Scope)**

### 3.1. Redis-Based Usage Data Processing

**Requirement 3.1.1: Redis Queue Integration**
- Consume usage records from a Redis queue populated by the AudioAPIServer.
- Process session data including:
  - `api_session_id`, `customer_id`
  - `product_code`
  - `connection_duration_seconds`, `data_bytes_processed`, `audio_duration_seconds`
  - `request_count` (number of API requests)
  - `request_timestamp`, `response_timestamp`
- `product_code` is fixed to `speech_transcription`.
- **Server-side Credit Calculation**: Control Plane calculates `credits_consumed` using global flat rate formula
- **Global Flat Rate**: Every 360 seconds costs 1 credit regardless of customer tier
- **Formula**: `credits = ceil(max(audio_duration_seconds, connection_duration_seconds) / 360)`
- **No Tier Discounts**: All customers (Free/Pro) pay the same rate
- Use Redis reliable queue patterns (e.g., BRPOPLPUSH) for message safety.
- Handle Redis connection failures with automatic reconnection.

**Requirement 3.1.2: Data Enrichment & Validation**
- Add server metadata to usage records:
  - `server_instance_id`, `api_server_region`
  - `processing_timestamp`, `agent_version`
- Validate data completeness and format
- Handle malformed or incomplete usage records gracefully
- **Usage Metrics Only**: Data Plane sends raw metrics, Control Plane handles all credit calculations

**Requirement 3.1.3: Guaranteed Delivery**
- Implement retry mechanism with exponential backoff for ControlPlane delivery
- Maintain local persistence for failed deliveries (Redis-based dead letter queue)
- Support manual retry and monitoring of failed deliveries
- Ensure no usage data loss under normal operation



### 3.3. Session & Queue Architecture

The agent's responsibilities for session management are:

- **Proactive Quota Refresh**: The Data Plane (specifically the AudioAPIServer) will push a notification to a Redis queue when an active session's quota is running low. The DataPlaneAgent will monitor this queue and request additional quota from the ControlPlane. Each quota refresh request must include a unique `transaction_id` to ensure idempotent processing.
- **Session Lifecycle Notifications**: The DataPlaneAgent will monitor Redis queues for session `start` and `complete` events generated by the AudioAPIServer and forward these to the ControlPlane.

**Core Redis Queues:**

- `queue:usage_records`: For batching and forwarding usage data.
- `queue:session_lifecycle`: For handling session start and completion events.
- `queue:quota_refresh`: For initiating proactive quota refresh requests.

### 3.4. ControlPlane Communication

**Requirement 3.4.1: REST API Client**
- Secure HTTPS client for ControlPlane communication over Internet
- **Authentication**: API Key-based authentication using `X-API-Key` header for DataPlane endpoints
- **Reduced Retry Logic**: Maximum of 2 retry attempts (reduced from 3) to prevent frequent retries during communication errors
- **Circuit Breaker**: Exponential backoff capped at 10 seconds to prevent aggressive retry behavior
- **Core Endpoints**:
  - `POST /api/v1/sessions/{sessionId}/usage-records` - Submit usage records.
  - `POST /api/v1/sessions/{sessionId}/start` - Notify ControlPlane of session start.
  - `POST /api/v1/sessions/{sessionId}/refresh` - Request additional quota for an active session.
  - `POST /api/v1/sessions/{sessionId}/complete` - Notify ControlPlane of session completion.
  - `POST /api/v1/servers/register` - Server registration (requires `X-API-Key` authentication).
  - `PUT /api/v1/servers/{id}/heartbeat` - Health updates (requires `X-API-Key` authentication).
  - `POST /api/v1/servers/{id}/shutdown` - Graceful shutdown notification (requires `X-API-Key` authentication).
  - `GET /api/v1/servers/{id}/commands` - Poll for pending commands (requires `X-API-Key` authentication).
  - `GET /api/v1/servers/{id}/public-keys` - Get JWT public keys (requires `X-API-Key` authentication).
- **Data Format**: All DataPlane endpoints use snake_case field names for consistency
- Connection timeout and circuit breaker for reliability

**Requirement 3.4.2: Server Registration**
- Register server on startup with basic metadata using snake_case field names:
  ```json
  {
    "server_id": "string",
    "region": "string",
    "ip_address": "string", 
    "port": number,
    "version": "string",
    "capabilities": {
      "max_concurrent_sessions": number,
      "supported_products": "string",
      "supported_languages": "string"
    }
  }
  ```
- **Simplified Capabilities**: Instead of complex arrays, capabilities use simple string fields for `supported_products` and `supported_languages` (comma-separated values).
- Registration supports upsert functionality - existing servers are updated rather than creating duplicates.
- **Session Reset**: When a server registers, its allocated session count is reset to 0 in the ControlPlane.
- Periodic heartbeat every 60 seconds with snake_case metrics:
  ```json
  {
    "status": "online|offline|degraded",
    "metrics": {
      "usage_records_processed": number,
      "control_plane_requests": number,
      "redis_queue_depth": number,
      "failed_deliveries": number,
      "memory_usage_mb": number,
      "cpu_usage_percent": number
    }
  }
  ```
- **Graceful shutdown notification**: The agent sends a shutdown notification to the ControlPlane via `POST /api/v1/servers/{server_id}/shutdown` when shutting down gracefully.

**Requirement 3.4.3: Command Processing**
- Support basic remote commands via HTTP polling from ControlPlane:
  - **refresh_public_keys**: Trigger JWT key refresh
  - **health_check**: Return server status
  - **get_metrics**: Return basic performance metrics
- **Command Flow**: ControlPlane Admin → ControlPlane API → DataPlaneAgent (polling) → Execution → Status Report
- DataPlaneAgent polls ControlPlane's command endpoint every 60 seconds
- Commands triggered by ControlPlane administrative interface or API
- Command validation and execution status reporting via HTTP response to ControlPlane
- Secure command authentication using JWT tokens
- **Command Deduplication**: Prevent duplicate command execution using command IDs:
  - Each command includes unique `command_id` from ControlPlane
  - DataPlaneAgent maintains local cache of executed command IDs (Redis-based)
  - Commands are skipped if `command_id` already exists in executed cache
  - Cache expires after 24 hours to prevent indefinite growth
  - Failed commands are retried but successful executions are never repeated

### 3.5. Health Monitoring & Metrics

**Requirement 3.5.1: Basic Health Monitoring**
- Monitor DataPlaneAgent process health:
  - Redis connection status
  - ControlPlane connectivity
  - Queue processing rates
  - Failed delivery counts
- Expose health status via HTTP endpoint for load balancer checks
- Log critical errors and connection failures

**Requirement 3.5.2: Metrics Integration**
- **Agent-Collected Metrics**:
  - Usage data processing rates
  - ControlPlane API response times
  - Redis queue depths and processing latency
  - Failed delivery counts and retry attempts
- **System Metrics** (via industry standard tools):
  - CPU, memory, disk usage (collected by node_exporter/Prometheus)
  - Network metrics (collected by system monitoring)
  - AudioAPIServer metrics (exposed via its own metrics endpoint)

**Requirement 3.5.3: Prometheus Integration**
- Expose metrics endpoint (`/metrics`) for Prometheus scraping over Internet
- Use standard Prometheus metric types (counter, gauge, histogram)
- Include relevant labels (server_id, region, queue_name)
- Support Grafana dashboard integration via Prometheus datasource
- **Internet-based Setup**: Prometheus server connects to DataPlaneAgent over HTTPS
- Secure metrics endpoint with authentication (API key or IP whitelist)
- Consider push-based metrics to Prometheus Gateway if pull-based is not feasible

### 3.6. Configuration Management

**Requirement 3.6.1: Configuration Structure**
- YAML-based configuration with environment variable overrides:
```yaml
server:
  id: "api-server-001"
  region: "us-east-1"
  port: 8081

redis:
  host: "localhost"
  port: 6379
  password: "${REDIS_PASSWORD}"
  db: 0

control_plane:
  base_url: "https://control.fantasia.ai"
  api_key: "${DATA_PLANE_API_KEY}"  # Used for X-API-Key header authentication
  timeout: 30
  retry_attempts: 3

monitoring:
  heartbeat_interval: 60
  metrics_port: 9090
  health_check_port: 8081
```
- Configuration validation on startup
- Support for environment-specific overrides

**Requirement 3.6.2: Deployment**
- Python package with systemd service integration
- Simple process management (start, stop, restart)
- Log rotation and basic monitoring
- Configuration file validation and error reporting

### 3.7. Security

**Requirement 3.7.1: Communication Security**
- HTTPS/TLS for all ControlPlane communication
- API Key-based authentication with ControlPlane using `X-API-Key` header
- Redis AUTH for Redis connections
- Secure storage of API keys and credentials

**Requirement 3.7.2: Data Protection**
- No persistent storage of sensitive customer data
- Secure handling of usage metrics in transit
- Audit logging for security events
- Input validation for all external data

### 3.8. Logging & Debugging

**Requirement 3.8.1: Structured Logging**
- JSON-structured logging with correlation IDs
- Configurable log levels (DEBUG, INFO, WARN, ERROR)
- Log rotation and retention (7 days default)
- Key events: startup, Redis connections, ControlPlane communication, errors

**Requirement 3.8.2: Error Handling**
- Graceful handling of Redis connection failures
- ControlPlane communication error recovery
- Detailed error logging with context
- Health status reporting for monitoring systems

**4. Technical Architecture & Implementation**

### 4.1. Technology Stack
- **Language**: Python 3.10+ (consistent with AudioAPIServer)
- **Framework**: FastAPI for REST endpoints, asyncio for concurrency
- **Database**: Redis for queuing and persistence
- **Monitoring**: Prometheus client, OpenTelemetry
- **Configuration**: Pydantic for validation, PyYAML for parsing
- **HTTP Client**: requests for synchronous HTTP calls in background threads
- **Process Management**: systemd integration, Docker support

### 4.2. MVP Service Architecture

The DataPlaneAgent employs a hybrid concurrency model to ensure responsiveness and robustness:
- **Async Core (FastAPI/Uvicorn)**: The main web server and the high-throughput Redis queue consumer (`RedisConsumerService`) run on the main `asyncio` event loop.
- **Synchronous Worker Threads**: Long-running background tasks that perform blocking I/O, such as polling the ControlPlane for commands (`CommandProcessor`) and sending heartbeats (`HealthMetricsService`), are run in a dedicated `ThreadPoolExecutor`. This prevents them from blocking the main event loop.
- **Async/Sync Communication**: A well-defined bridge allows `async` services to safely call and retrieve results from the synchronous workers and vice-versa, ensuring clean separation of concerns.

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  AudioAPIServer │    │  DataPlaneAgent │    │   ControlPlane  │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │MeteringService│◄┼────┼►│UsageProcessor│ │    │ │ UsageAPI    │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │QueueManager │◄┼────┼►│RedisClient  │ │    │ │ KeysAPI     │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │WebSocketMgr │◄┼────┼►│HealthMonitor│ │    │ │ ServerAPI   │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 4.3. MVP Data Flow
1. **Usage Collection**: AudioAPIServer sends usage data to Redis queue
2. **Data Processing**: DataPlaneAgent's `RedisConsumerService` (async) processes queue messages.
3. **Data Enrichment**: Add server metadata and validation.
4. **Transmission**: The `ControlPlaneClient` provides both `async` and `sync` methods. 
   - `async` methods use `run_in_executor` to call a synchronous request function in a background thread.
   - Synchronous methods are called directly by the worker threads.
5. **Key Management**: Fetch and cache JWT public keys.
6. **Health Reporting**: The `HealthMonitor` runs in a background thread, periodically sending heartbeats.

### 4.4. MVP Error Handling
- **Redis Failures**: Auto-reconnect with exponential backoff handled by the `redis-py` library.
- **ControlPlane Failures**: Each synchronous worker implements its own self-contained retry logic with exponential backoff and circuit breaking behavior, logging failures and backoff intervals.
- **Robust Connections**: All HTTP requests are made in a new session with the `Connection: close` header to prevent issues with stale connections.
- **Async/Sync Bridge**: A `SyncRequestResult` object is used to safely pass success or failure information from the synchronous HTTP request thread back to the asynchronous context, where errors can be handled appropriately.
- **Process Failures**: Systemd automatic restart

**5. MVP Success Criteria & Technology Stack**

### 5.1. MVP Success Criteria

**Functional Requirements:**
- Successfully process usage metrics from Redis queue
- Reliably forward metrics to ControlPlane (99% success rate)
- Fetch and cache JWT public keys
- Respond to key refresh commands
- Expose health and metrics endpoints
- Handle Redis and network failures gracefully

**Performance Requirements:**
- Process 100 usage records per minute
- Memory usage under 128MB
- CPU usage under 25% on single core
- Startup time under 30 seconds
- Health check response under 1 second

### 5.2. Technology Stack

**Core Dependencies:**
```
fastapi==0.104.1
redis==5.0.1
requests==2.31.0
pyyaml==6.0.1
structlog==23.2.0
prometheus-client==0.19.0
pydantic==2.5.0
uvicorn==0.24.0
```

**Development Tools:**
```
pytest==7.4.3
black==23.11.0
flake8==6.1.0
mypy==1.7.1
```

**6. MVP Validation & Testing**

### 6.1. Testing Strategy

**Unit Testing:**
- Test usage data processing logic
- Test Redis queue operations
- Test ControlPlane API client
- Test key management functionality
- Test error handling scenarios

**Integration Testing:**
- End-to-end usage data flow
- Redis connection failure scenarios
- ControlPlane API failure scenarios
- Key refresh workflow
- Health check functionality

**Manual Testing:**
- Deploy in test environment
- Verify metrics forwarding
- Test key refresh commands
- Validate monitoring endpoints
- Test service restart scenarios

### 6.2. MVP Validation Criteria

**Core Functionality:**
- ✅ Process usage metrics from Redis queue
- ✅ Forward metrics to ControlPlane successfully
- ✅ Handle Redis connection failures
- ✅ Fetch and cache JWT public keys
- ✅ Respond to key refresh commands
- ✅ Expose health and metrics endpoints

**Reliability:**
- ✅ Automatic reconnection to Redis
- ✅ Retry failed ControlPlane deliveries
- ✅ Graceful handling of malformed messages
- ✅ Service restart without data loss
- ✅ Proper error logging and monitoring

**Performance:**
- ✅ Process target message volume
- ✅ Memory usage within limits
- ✅ Startup time acceptable
- ✅ Health check responsiveness

**7. Appendices**

### Appendix A: MVP Configuration Reference

**Basic Configuration Schema:**
```yaml
# DataPlaneAgent MVP Configuration
server:
  id: "${SERVER_ID}"                    # Unique server identifier
  region: "${AWS_REGION}"               # Deployment region
  port: 8081                            # HTTP server port

# Redis Configuration
redis:
  host: "${REDIS_HOST}"                # Redis server host
  port: 6379                           # Redis server port
  password: "${REDIS_PASSWORD}"        # Redis authentication
  db: 0                                # Redis database number
  socket_timeout: 30                   # Socket timeout (seconds)
  retry_on_timeout: true               # Retry on timeout

# ControlPlane Configuration
control_plane:
  base_url: "${CONTROL_PLANE_URL}"     # ControlPlane base URL
  api_key: "${CONTROL_PLANE_API_KEY}"  # API authentication key
  timeout: 30                          # Request timeout (seconds)
  retry_attempts: 3                    # Maximum retry attempts

# Monitoring Configuration
monitoring:
  heartbeat_interval: 60               # Heartbeat interval (seconds)
  metrics_port: 9090                   # Prometheus metrics port
  health_check_port: 8081              # Health check port
  log_level: "INFO"                    # Logging level
  log_retention_days: 7                # Log retention period
```

### Appendix B: MVP API Reference

**Health Check Endpoint:**
```http
GET /health
Response: 200 OK
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00Z",
  "version": "1.0.0",
  "uptime_seconds": 3600,
  "redis_connected": true,
  "control_plane_connected": true
}
```

**Metrics Endpoint:**
```http
GET /metrics
Response: 200 OK
Content-Type: text/plain

# HELP usage_records_processed_total Total usage records processed
# TYPE usage_records_processed_total counter
usage_records_processed_total{server_id="api-server-001"} 1234

# HELP redis_connection_status Redis connection status
# TYPE redis_connection_status gauge
redis_connection_status{server_id="api-server-001"} 1
```

### Appendix C: MVP Deployment

**Systemd Service Template:**
```ini
[Unit]
Description=DataPlane Agent
After=network.target redis.service
Requires=redis.service

[Service]
Type=simple
User=dataplane
Group=dataplane
WorkingDirectory=/opt/dataplane-agent
ExecStart=/opt/dataplane-agent/venv/bin/python -m dataplane_agent
Restart=always
RestartSec=10
Environment=PYTHONPATH=/opt/dataplane-agent
EnvironmentFile=/etc/dataplane-agent/environment

[Install]
WantedBy=multi-user.target
```

**Installation Script:**
```bash
#!/bin/bash
# DataPlane Agent Installation Script

# Create user and directories
sudo useradd -r -s /bin/false dataplane
sudo mkdir -p /opt/dataplane-agent
sudo mkdir -p /etc/dataplane-agent
sudo mkdir -p /var/log/dataplane-agent

# Install Python package
sudo pip install dataplane-agent

# Copy configuration
sudo cp config.yaml /etc/dataplane-agent/
sudo cp environment /etc/dataplane-agent/

# Install systemd service
sudo cp dataplane-agent.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable dataplane-agent

# Set permissions
sudo chown -R dataplane:dataplane /opt/dataplane-agent
sudo chown -R dataplane:dataplane /var/log/dataplane-agent

# Start service
sudo systemctl start dataplane-agent
```

### Appendix D: MVP Troubleshooting

**Common Issues:**

1. **Service Won't Start**
   ```bash
   # Check service status
   sudo systemctl status dataplane-agent
   
   # Check logs
   sudo journalctl -u dataplane-agent -f
   
   # Validate configuration
   python -m dataplane_agent --validate-config
   ```

2. **Redis Connection Issues**
   ```bash
   # Test Redis connectivity
   redis-cli -h $REDIS_HOST -p $REDIS_PORT ping
   
   # Check Redis logs
   sudo journalctl -u redis -f
   ```

3. **ControlPlane Communication Issues**
   ```bash
   # Test API connectivity
   curl -H "Authorization: Bearer $API_KEY" $CONTROL_PLANE_URL/health
   
   # Check network connectivity
   ping control.fantasia.ai
   ```

**Diagnostic Commands:**
```bash
# Service management
sudo systemctl start|stop|restart dataplane-agent
sudo systemctl status dataplane-agent

# Log monitoring
sudo journalctl -u dataplane-agent -f
tail -f /var/log/dataplane-agent/app.log

# Health checks
curl http://localhost:8081/health
curl http://localhost:9090/metrics

# Configuration validation
python -m dataplane_agent --check-config
```